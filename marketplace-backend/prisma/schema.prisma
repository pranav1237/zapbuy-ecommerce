generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ============ USER & AUTH ============

model User {
  id            String    @id @default(cuid())
  email         String    @unique
  passwordHash  String
  firstName     String
  lastName      String
  avatar        String?
  phoneNumber   String?
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt
  
  // Relations
  role          Role      @default(BUYER)
  vendor        Vendor?
  buyer         Buyer?
  
  @@index([email])
}

enum Role {
  BUYER
  VENDOR
  ADMIN
}

model Vendor {
  id            String    @id @default(cuid())
  userId        String    @unique
  user          User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  // Vendor Details
  shopName      String
  shopSlug      String    @unique
  description   String?
  logo          String?
  bannerImage   String?
  
  // Location
  latitude      Float
  longitude     Float
  address       String
  city          String
  state         String
  zipCode       String
  country       String
  
  // Status
  isVerified    Boolean   @default(false)
  isActive      Boolean   @default(true)
  
  // Stripe
  stripeAccountId String?
  stripeAccountStatus String? @default("not_started") // not_started, pending, complete
  
  // Metadata
  totalSales    Decimal   @default(0) @db.Decimal(10, 2)
  totalEarnings Decimal   @default(0) @db.Decimal(10, 2)
  rating        Float     @default(0)
  reviewCount   Int       @default(0)
  
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt
  
  // Relations
  products      Product[]
  orders        VendorOrder[]
  reviews       Review[]
  payouts       Payout[]
  
  @@index([shopSlug])
  @@index([userId])
}

model Buyer {
  id            String    @id @default(cuid())
  userId        String    @unique
  user          User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  // Address
  defaultAddress String?
  addresses     Address[]
  
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt
  
  // Relations
  cart          Cart?
  orders        Order[]
  reviews       Review[]
}

// ============ PRODUCTS ============

model Product {
  id            String    @id @default(cuid())
  vendorId      String
  vendor        Vendor    @relation(fields: [vendorId], references: [id], onDelete: Cascade)
  
  // Basic Info
  name          String
  slug          String    @unique
  description   String
  
  // Pricing
  price         Decimal   @db.Decimal(10, 2)
  compareAtPrice Decimal? @db.Decimal(10, 2)
  
  // Categorization
  category      String
  tags          String[]  @default([])
  
  // Inventory
  stock         Int
  reserved      Int       @default(0) // Reserved in active carts
  
  // Status
  status        ProductStatus @default(DRAFT)
  
  // Media
  images        ProductImage[]
  
  // SEO & Metadata
  seoTitle      String?
  seoDescription String?
  
  // Rating
  rating        Float     @default(0)
  reviewCount   Int       @default(0)
  
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt
  
  // Relations
  cartItems     CartItem[]
  orderItems    OrderItem[]
  reviews       Review[]
  
  @@index([vendorId])
  @@index([slug])
  @@index([status])
}

enum ProductStatus {
  DRAFT
  PUBLISHED
  ARCHIVED
}

model ProductImage {
  id            String    @id @default(cuid())
  productId     String
  product       Product   @relation(fields: [productId], references: [id], onDelete: Cascade)
  
  url           String
  altText       String?
  isThumbnail   Boolean   @default(false)
  order         Int       @default(0)
  
  createdAt     DateTime  @default(now())
  
  @@index([productId])
}

// ============ SHOPPING & CHECKOUT ============

model Cart {
  id            String    @id @default(cuid())
  buyerId       String    @unique
  buyer         Buyer     @relation(fields: [buyerId], references: [id], onDelete: Cascade)
  
  items         CartItem[]
  
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt
}

model CartItem {
  id            String    @id @default(cuid())
  cartId        String
  cart          Cart      @relation(fields: [cartId], references: [id], onDelete: Cascade)
  
  productId     String
  product       Product   @relation(fields: [productId], references: [id], onDelete: Cascade)
  
  quantity      Int
  priceAtAdd    Decimal   @db.Decimal(10, 2)
  
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt
  
  @@unique([cartId, productId])
  @@index([cartId])
  @@index([productId])
}

model Address {
  id            String    @id @default(cuid())
  buyerId       String
  buyer         Buyer     @relation(fields: [buyerId], references: [id], onDelete: Cascade)
  
  fullName      String
  phoneNumber   String
  addressLine1  String
  addressLine2  String?
  city          String
  state         String
  zipCode       String
  country       String
  isDefault     Boolean   @default(false)
  
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt
  
  @@index([buyerId])
}

// ============ ORDERS & PAYMENTS ============

model Order {
  id            String    @id @default(cuid())
  buyerId       String
  buyer         Buyer     @relation(fields: [buyerId], references: [id], onDelete: Restrict)
  
  // Order Details
  orderNumber   String    @unique @default(cuid()) // Human-readable order ID
  status        OrderStatus @default(PENDING)
  
  // Shipping
  shippingAddress String
  shippingCost  Decimal   @default(0) @db.Decimal(10, 2)
  
  // Pricing
  subtotal      Decimal   @db.Decimal(10, 2)
  platformFee   Decimal   @default(0) @db.Decimal(10, 2)
  total         Decimal   @db.Decimal(10, 2)
  
  // Payment
  paymentMethodId String?
  paymentStatus PaymentStatus @default(PENDING)
  stripePaymentIntentId String?
  
  // Metadata
  notes         String?
  
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt
  
  // Relations
  items         OrderItem[]
  vendorOrders  VendorOrder[]
  payment       Payment?
  
  @@index([buyerId])
  @@index([status])
  @@index([paymentStatus])
  @@index([orderNumber])
}

enum OrderStatus {
  PENDING        // Order created, awaiting payment
  CONFIRMED      // Payment confirmed
  PROCESSING     // Vendor preparing
  SHIPPED        // In transit
  DELIVERED      // Delivered
  CANCELLED      // Order cancelled
  RETURNED       // Order returned
}

enum PaymentStatus {
  PENDING
  PROCESSING
  COMPLETED
  FAILED
  REFUNDED
}

model OrderItem {
  id            String    @id @default(cuid())
  orderId       String
  order         Order     @relation(fields: [orderId], references: [id], onDelete: Cascade)
  
  productId     String
  product       Product   @relation(fields: [productId], references: [id], onDelete: Restrict)
  
  quantity      Int
  unitPrice     Decimal   @db.Decimal(10, 2)
  subtotal      Decimal   @db.Decimal(10, 2)
  
  @@index([orderId])
  @@index([productId])
}

// One VendorOrder per Order per Vendor
model VendorOrder {
  id            String    @id @default(cuid())
  orderId       String
  order         Order     @relation(fields: [orderId], references: [id], onDelete: Cascade)
  
  vendorId      String
  vendor        Vendor    @relation(fields: [vendorId], references: [id], onDelete: Restrict)
  
  status        VendorOrderStatus @default(PENDING)
  subtotal      Decimal   @db.Decimal(10, 2)
  vendorEarnings Decimal  @db.Decimal(10, 2) // After platform fee
  
  trackingNumber String?
  notes         String?
  
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt
  
  @@unique([orderId, vendorId])
  @@index([orderId])
  @@index([vendorId])
  @@index([status])
}

enum VendorOrderStatus {
  PENDING
  CONFIRMED
  PROCESSING
  SHIPPED
  DELIVERED
  CANCELLED
  REFUNDED
}

model Payment {
  id            String    @id @default(cuid())
  orderId       String    @unique
  order         Order     @relation(fields: [orderId], references: [id], onDelete: Cascade)
  
  paymentMethod PaymentMethod
  status        PaymentStatus @default(PENDING)
  
  // Stripe
  stripePaymentIntentId String?
  
  amount        Decimal   @db.Decimal(10, 2)
  currency      String    @default("USD")
  
  failureReason String?
  
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt
  
  @@index([orderId])
}

enum PaymentMethod {
  CARD
  UPI
  NETBANKING
  WALLET
}

model Payout {
  id            String    @id @default(cuid())
  vendorId      String
  vendor        Vendor    @relation(fields: [vendorId], references: [id], onDelete: Restrict)
  
  amount        Decimal   @db.Decimal(10, 2)
  status        PayoutStatus @default(PENDING)
  
  stripeBankAccountId String?
  stripePayoutId String?
  
  periodStart   DateTime
  periodEnd     DateTime
  
  failureReason String?
  
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt
  
  @@index([vendorId])
  @@index([status])
}

enum PayoutStatus {
  PENDING
  PROCESSING
  PAID
  FAILED
  CANCELLED
}

// ============ REVIEWS & RATINGS ============

model Review {
  id            String    @id @default(cuid())
  productId     String
  product       Product   @relation(fields: [productId], references: [id], onDelete: Cascade)
  
  vendorId      String
  vendor        Vendor    @relation(fields: [vendorId], references: [id], onDelete: Cascade)
  
  buyerId       String
  buyer         Buyer     @relation(fields: [buyerId], references: [id], onDelete: Cascade)
  
  // From completed order
  orderId       String
  
  rating        Int // 1-5
  title         String
  content       String
  
  // Moderation
  isVerified    Boolean   @default(true)
  isApproved    Boolean   @default(true)
  
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt
  
  @@unique([productId, buyerId, orderId])
  @@index([productId])
  @@index([vendorId])
  @@index([buyerId])
}
